# AMB Feedback Bot (Manual Installation)

Бот обратной связи представляет из себя связанную систему из тг-бота и тг-группы. В тг-бота пользователи пишут сообщения. Тг-группа — это «коллцентр», в который тг-бот будет пересылать сообщения пользователей. Админы взаимодействуют с пользователями только через тг-группу, через нее админы отправлют ответы пользователям.

Бот имеет возможности:
- диалог с каждым пользователем в отдельной теме внутри тг-группы
- админы могут редактировать свой ответ, ответ админа изменится у юзера (просто редактируете ранее отправленное сообщение в тг-группе) 
- бан конкретного пользователя, т.е. сообщения юзера перестанут пересылаться в тг-группу (командой /ban в тг-группе)
- разбан конкретного пользователя, т.е. сообщения юзера начнут пересылаться в тг-группу (командой /unban в тг-группе)
- админ может удалять сообщения пользователя в чате у юзера (reply-ответом на конкретное сообщение с командой /delete в тг-группе)
- админ может удалять свои сообщения в чате у юзера (reply-ответом на конкретное сообщение с командой /delete в тг-группе)
- админ может удалить всю историю переписки в чате у юзера (командой /delhistory в тг-группе)
- бот уведомляет об изменении никнейма или имени пользователя, можно посмотреть историю этих изменений (командой /userlog в тг группе)

## Инструкция по запуску бота обратной связи

С инструкцией справится любой пользователь компьютера, никакие специфические навыки не требуются. Внимательно читайте и делайте по порядку

### А) Предварительная подготовка:

0. У вас есть компьютер/ноутбук c любой из операционных систем: Windows, MacOS, Linux.

1. У какого-нибудь хостинга арендовать виртуальный сервер (VPS) с Ubuntu-22.04 или Ubuntu-24.04. VPS нужен для того, чтобы бот работал 24 часа в сутки, чтобы у него всегда было электричество и интернет-связь (личный компьютер подвержен рискам отключений). Шаги:
    * 1.1. выбрать хостинг
    * 1.2. регистрация на сайте хостинга
    * 1.3. выбрать сервер у хостинга (подойдет самый дешевый)
    * 1.4. оплатить сервер
    * 1.5. получить от хостинга 3 поля вашего арендованного сервера для подключения к нему (обычно после оплаты автоматически приходит информация на почту или в личный кабинет хостинга). Поля: server_ip, ssh_login (обычно это root или administranor) и ssh_password

2. Установить программу для обмена файлами с сервером:
    * 2.1 если у вас Windows — скачать и установить WinSCP с официального сайта: https://winscp.net/eng/download.php
    * 2.2 если у вас Linux/MacOS — скачать и установить FileZilla с официального сайта: https://filezilla-project.org/download.php

3. Скачать и установить программу PuTTY для доступа к командной строке сервера:
    * 3.1. если у вас Windows — скачать с официального сайта: https://www.putty.org (в нижней части сайта будет ссылка на скачивание установщка на фразе «Looking for PuTTY, the software? It's here»)
    * 3.2. если у вас Linux — установить в терминале командой: sudo apt install putty
    * 3.2. если у вас MacOS — установить в терминале командой (возможно, предварительно потребуется установить MacPorts): sudo port install putty

4. Создать тг-бота у https://t.me/BotFather . При создании BotFather пришлет «токен» (это строка из символов), сохраните его

5. Создать тг-группу. Нужно узнать и сохранить ID созданной группы с помощью шагов:
    * 5.1. включите в группе «темы»/«топики» (Управление групой -> Темы -> Включить темы)
    * 5.2. выдайте себе возможноть отправлять сообщения от имени группы (Управление группой -> Администраторы -> Правой кнопкой на себя -> Изменить права -> Анонимность ВКЛ)
    * 5.3. напишите любое текстовое сообщение в топик «#General» от имени группы 
    * 5.4. перешлите свое сообщение от имени группы в бот https://t.me/TheGetAnyID_bot , он пришлет ID группы (это отрицательное число с 10-15 знаками), сохраните ID группы

6. Добавить тг-бота в тг-группу и сделать бота админом с правами «управлять темами» и «закреплять сообщения» (управление группой -> администраторы -> правой кнопкой на бота -> изменить права)

### Б) Настройка сервера:

0. Вы сделали все пункты из предворительной подготовки. У вас есть 5 полей:
    * server_ip
    * ssh_login
    * ssh_password
    * token тг-бота
    * ID тг-группы «коллцентра»

1. Подключиться к арендованному серверу. Это можно сделать разными способами, но советуем сделать это через программу PuTTY с помощью шагов:
    * 1.1. запустите PuTTY (на Windows — клик по иконке программы, на MacOS/Linux - отправьте в терминал команду из одного слова: putty)
    * 1.2. ведите IP-адрес сервера: server_ip
    * 1.3. проверьте, что «Port» указан 22
    * 1.4. проверьте, что «Connection type» выбран SSH.
    * 1.5. нажмите кнопку «Open»
    * 1.6. при первом подключении появится окно про ключ шифрования, нажмите «Accept»
    * 1.7. откроется окно терминала с предложением ввести логин: login as: введите ssh_login и нажмите клавишу «Enter».
    * 1.8. далее запросит password: введите пароль ssh_password. Пароль в терминал можно вводить посимвольно, но можно его заранее скопировать, а после — вставить с помощью сочетания клавиш Ctrl+Shift+V либо нажатия на правую кнопку мыши. ВНИМАНИЕ — введённые/вставленные символы пароля не отображаются. После ввода пароля нажмите клавишу «Enter».
    * 1.9. если логин и пароль введены верно, то вход на сервер будет успешным, а в окне PuTTY появится приветственное сообщение и откроется возможность ввода команд
    * 1.10. *при проблемах с подключением посмотрите любой интернет/видео гайд «как подключиться через к серверу с помощью PuTTY» 

2. Далее ввести команды в PuTTY. Каждая следующая команда отправляется только после выполнения сервером предыдущей:
    * установить docker командой: `curl https://get.docker.com | sh`
    * выдаем права командой: `useradd -m -g docker docker`
    * переходим в папку командой: `cd /home/docker`
    * скачиваем код на сервер командой: `git clone https://github.com/amb-code/amb-feedback-bot-minst.git amb-feedback-bot`
    * выдаем права командой: `chown -R 1000:100 /home/docker/amb-feedback-bot`
    * можно закрыть PuTTY

3. Чтобы бот работал, в его параметры нужно записать токен вашего тг-бота, ID группы-коллцентра и отправить параметры на сервер. Это можно сделать с помощью шагов: 
    * скачать файл bot.env отсюда: https://github.com/amb-code/amb-feedback-bot-minst/blob/main/env/bot.env (там есть кнопка «Download raw file» со стрелочкой на ее иконке)
    * открыть его в любом тектовом редакторе (Notepad++, Блокнот, WordPad, MicrosoftWord и др)
    * в поле «TG_TOKEN=» вместо «88005553535:KRYsdE8DSVL12ur1RfMaxLLWYhQ_idRT» записать токен вашего тг бота
    * в поле «TG_CHAT_ID=» вместо «-1001234567890» записать ID вашей группы (также с минусом).
    * сохранить изменения в файле bot.env (проверьте, что файл также называется bot и имеет расширение .env)
    * подключиться к серверу через программу winSCP/FileZilla (при подключении проверить протокол передачи: SFTP, Порт : 22, Имя хоста:  server_ip, Имя пользователя: ssh_login, Пароль: ssh_password)
    * при успешном подключении откроется окно, в левой части будут директории вашего компьютера, в правой - директории удаленного сервера.
    * в левой части нужно перейти в папку, где хранится новая исправленная вами версия bot.env . В правой части нужно перейти в папку на сервере /home/docker/amb-feedback-bot/env/ , где хранится старая версия файла bot.env 
    * перетащить отредактированный файл bot.env из левой части окна в правую, согласиться на перезапись этого файла на сервере
    * закрыть winSCP или FileZilla

### В) Запуск и перезапуск бота

0. Ранее вы сделали все пункты из А) Предварительной подготовки и Б) Настройки сервера

1. Подключиться к серверу через программу PuTTY

2. Перейти в папку командой: `cd /home/docker/amb-feedback-bot`

3. *(Пропустить этот пункт при первом запуске бота) Если ранее бот был запущен и вы хотите перезапустить, то предварительно введите команду для его выключения: `docker compose down`

4. Введите команду для запуска: `docker compose up -d`

5. Бот запущен. Проверить логи бота, чтобы в них не было никаких ошибок и последняя строчка в логах была «... INFO ... POST-INIT: Bot ready, listening...», командой: `docker compose logs feedback-bot`

6. Можно закрыть PuTTY

7. В тг-группу можно добавить других людей, которые будут ответственны за ответы на вопросы пользователей из бота. Протестируйте работу всех функции через тг-бота и тг-группу
    * проверьте, что тг-бот создает разные темы-диалоги в тг-группе для разных людей
    * проверьте, что вы можете редактировать свой ответ (просто редактируете ранее отправленное сообщение в тг-группе)
    * проверьте, что вы можете банить/разбанить конкретного пользвателя (команды /ban и /unban в тг-группе)
    * проверьте, что вы можете удалять свои сообщения, сообщения пользователя или все сообщения у пользователя (командой /delhistory и reply-ответом на конкретное сообщение с командой /delete в тг-группе)
    * проверьте, что бот видит изменение имени или никнейма у юзера, с которым есть диалог (команда /userlog в тг-группе)
